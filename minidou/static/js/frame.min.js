var data_cache = {};

function load_status() {
	var e = 0;
	var c = 0;
	var a = 0;
	var f = 0;
	for (var d in data_cache) {
		if (data_cache[d].success == false) {
			e++;
			c += data_cache[d].filesize;
			a += data_cache[d].finished
		} else {
			f += data_cache[d].filesize
		}
	}
	var g = "ready.";
	var b = 300;
	if (c > 0) {
		g = e + " files, " + (a / 1024).toFixed(1) + " / " + (c / 1024).toFixed(1) + "KB";
		g += ", " + (a / c * 100).toFixed(1) + "%";
		b = a / c * 300
	}
	$(".load-status").html(g);
	$(".load-status-300").html(g + '<div class="progress" style="width:' + b + 'px;"></div>')
}
function load_data(c, a) {
	if (data_cache[c] != undefined) {
		if (data_cache[c].success) {
			return data_cache[c].data
		}
	}
	data_cache[c] = {
		finished: 0,
		filesize: 0,
		success: false
	};
	var d = "";
	var b = function() {
		// $.get("http://vis.pku.edu.cn/weibova/weiboevents/fetch.php", {
		// 	file: c,
		// 	start: d.length
		// }, function(e) {
			//e = $.parseJSON(e);
			e = xdata;
			d += e.data;
			data_cache[c].filesize = e.filesize;
			data_cache[c].finished = d.length;
			data_cache[c].success = true;
			data_cache[c].data = ydata;
			load_status();
			setTimeout(function() {
				a(data_cache[c].data)
			}, 10)
			// if (d.length == e.filesize) {
			// 	data_cache[c].success = true;
			// 	data_cache[c].data = $.parseJSON(d);
			// 	load_status();
			// 	setTimeout(function() {
			// 		a(data_cache[c].data)
			// 	}, 10)
			// } else {
			// 	load_status();
			// 	b()
			// }
		// }) 
	};
	b()
}(function() {
	function e(m) {
		var f = [];
		for (var k = 0; k < m.length; k++) {
			if (m.charCodeAt(k) <= 127) {
				f.push(m.charCodeAt(k))
			} else {
				var l = encodeURIComponent(m.charAt(k)).substr(1).split("%");
				for (var g = 0; g < l.length; g++) {
					f.push(parseInt(l[g], 16))
				}
			}
		}
		return f
	}
	function b(f) {
		var g = "";
		var h = 0;
		var j = c1 = c2 = 0;
		while (h < f.length) {
			j = f[h];
			if (j < 128) {
				g += String.fromCharCode(j);
				h++
			} else {
				if ((j > 191) && (j < 224) && h + 1 < f.length) {
					c2 = f[h + 1];
					g += String.fromCharCode(((j & 31) << 6) | (c2 & 63));
					h += 2
				} else {
					if (h + 2 <= f.length) {
						c2 = f[h + 1];
						c3 = f[h + 2];
						g += String.fromCharCode(((j & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
						h += 3
					}
				}
			}
		}
		return g
	}
	function d(j) {
		var f = [];
		var h = function(i) {
			if (i <= 57 && i >= 48) {
				return i - 48
			}
			if (i <= 102 && i >= 97) {
				return i - 97 + 10
			}
			if (i <= 70 && i >= 65) {
				return i - 65 + 10
			}
			return 0
		};
		for (var g = 0; g < j.length; g += 2) {
			f.push(h(j.charCodeAt(g)) << 4 | h(j.charCodeAt(g + 1)))
		}
		return f
	}
	function a(f) {
		var j = "";
		var h = "0123456789abcdef";
		for (var g = 0; g < f.length; g++) {
			j += h[f[g] >> 4];
			j += h[f[g] % 16]
		}
		return j
	}
	function c(h) {
		var g = function(i, s) {
			var q = (i & 65535) + (s & 65535);
			var r = (i >> 16) + (s >> 16) + (q >> 16);
			return (r << 16) | (q & 65535)
		};
		var o = function(q, i) {
			return (i << q) | (i >>> (32 - q))
		};
		var m = function(i) {
			if (i < 20) {
				return 1518500249
			}
			if (i < 40) {
				return 1859775393
			}
			if (i < 60) {
				return 2400959708
			}
			return 3395469782
		};
		var l = function(i, s, r, q) {
			if (i < 20) {
				return (s & r) | ((~s) & q)
			}
			if (i < 40) {
				return s ^ r ^ q
			}
			if (i < 60) {
				return (s & r) | (s & q) | (r & q)
			}
			return s ^ r ^ q
		};
		var f = function(r) {
			var q = 8 * r.length;
			r.push(128);
			var t = 56 - r.length % 64;
			if (t < 0) {
				t += 64
			}
			for (var s = 0; s < t; s++) {
				r.push(0)
			}
			r.push(0);
			r.push(0);
			r.push(0);
			r.push(0);
			r.push((q >> 24) & 255);
			r.push((q >> 16) & 255);
			r.push((q >> 8) & 255);
			r.push(q & 255);
			return r
		};
		bytes = f(h);
		words = [];
		for (var j = 0; j < bytes.length; j += 4) {
			var n = bytes[j] << 24 | bytes[j + 1] << 16 | bytes[j + 2] << 8 | bytes[j + 3];
			words.push(n)
		}
		H = [1732584193, 4023233417, 2562383102, 271733878, 3285377520];
		for (var j = 0; j < words.length; j += 16) {
			W = [];
			for (var p = 0; p < 16; p++) {
				W[p] = words[j + p]
			}
			for (var p = 16; p < 80; p++) {
				W[p] = o(1, W[p - 3] ^ W[p - 8] ^ W[p - 14] ^ W[p - 16])
			}
			A = H[0];
			B = H[1];
			C = H[2];
			D = H[3];
			E = H[4];
			for (var p = 0; p < 80; p++) {
				tmp = g(o(5, A), g(g(g(l(p, B, C, D), E), W[p]), m(p)));
				E = D;
				D = C;
				C = o(30, B);
				B = A;
				A = tmp
			}
			H[0] = g(H[0], A);
			H[1] = g(H[1], B);
			H[2] = g(H[2], C);
			H[3] = g(H[3], D);
			H[4] = g(H[4], E)
		}
		var k = [];
		for (var j = 0; j < 5; j++) {
			k.push((H[j] >> 24) & 255);
			k.push((H[j] >> 16) & 255);
			k.push((H[j] >> 8) & 255);
			k.push(H[j] & 255)
		}
		return k
	}
	sha1_str = function(f) {
		return a(c(e(f)))
	}
})();
$(document).ready(function() {
	$(".draggable").each(function() {
		var c = undefined;
		var a = $(this);
		var b = $(this);
		if ($(this).children(".drag-header").length > 0) {
			b = $(this).children(".drag-header")
		}
		b.mousedown(function(d) {
			c = {
				x: d.screenX,
				y: d.screenY,
				x0: parseInt(a.css("right").replace("px", "")),
				y0: parseInt(a.css("bottom").replace("px", ""))
			}
		});
		$(window).mouseup(function() {
			c = undefined
		});
		$(window).mousemove(function(g) {
			if (c != undefined) {
				var f = g.screenX - c.x;
				var d = g.screenY - c.y;
				a.css("right", (c.x0 - f) + "px");
				a.css("bottom", (c.y0 - d) + "px")
			}
		})
	});
	$(".pkuvis-slider").each(function() {
		var g = this;
		g.slider_value = 0;
		var f = parseInt($(g).css("width").replace("px", ""));
		$(g).css("position", "relative").css("height", "16px").css("border-radius", "5px").css("display", "inline-block").css("vertical-align", "top").css("margin", "4px").css("background-color", "#CCC");
		g.innerHTML += '<div style="width:16px;height:16px;position:absolute;top:0;left:0;background-color:#1f77b4;border-radius:5px"></div>';
		var h = $(g).children("div");
		h.css("cursor", "pointer");
		var a = false;
		var e = 0,
			c = 0;
		var d = function(i) {
			var j = i / (f - 16);
			g.slider_value = j;
			if (g.onvaluechanged != undefined) {
				g.onvaluechanged(j)
			}
		};
		var b = function() {
			if (g.onvaluechanged_up != undefined) {
				g.onvaluechanged_up(g.slider_value)
			}
		};
		g.slider_set = function(j) {
			var i = j * (f - 16);
			h.css("left", i + "px")
		};
		if (g.getAttribute("class").match(/pkuvis-slider-center/) != undefined) {
			g.slider_set(0.5)
		}
		h.mousedown(function(i) {
			a = true;
			e = i.pageX;
			c = parseInt(h.css("left").replace("px", ""))
		});
		$(g).mousedown(function(i) {
			var j = i.pageX - $(g).offset().left - 8;
			if (j < 0) {
				j = 0
			}
			if (j > f - 16) {
				j = f - 16
			}
			d(j);
			h.css("left", j + "px");
			a = true
		});
		$(window).mousemove(function(i) {
			if (a) {
				var j = c + i.pageX - e;
				if (j < 0) {
					j = 0
				}
				if (j > f - 16) {
					j = f - 16
				}
				d(j);
				h.css("left", j + "px")
			}
		});
		$(window).mouseup(function() {
			if (a) {
				a = false;
				b()
			}
		})
	})
});

function Weibo_str62to10(e) {
	var a = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"];
	var b = 0;
	for (var c = 0; c < e.length; c++) {
		var f = e.length - c - 1;
		var d = e[c];
		b += a.indexOf(d) * Math.pow(62, f)
	}
	return b
}
function Weibo_int10to62(d) {
	var a = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"];
	var b = "";
	var c = 0;
	while (d != 0) {
		c = d % 62;
		b = a[c] + b;
		d = Math.floor(d / 62)
	}
	return b
}
function Weibo_url2mid(b) {
	var a = "";
	for (var c = b.length - 4; c > -4; c -= 4) {
		var e = c < 0 ? 0 : c;
		var d = c + 4;
		var f = b.substring(e, d);
		f = Weibo_str62to10(f).toString();
		if (e > 0) {
			while (f.length < 7) {
				f = "0" + f
			}
		}
		a = f + a
	}
	return a
}
function Weibo_miduid2url(c, e) {
	var b = "";
	for (var d = c.length - 7; d > -7; d = d - 7) {
		var g = d < 0 ? 0 : d;
		var f = d + 7;
		var a = c.substring(g, f);
		a = Weibo_int10to62(a);
		b = a + b
	}
	return "http://weibo.com/" + e + "/" + b
}
var pkuvis_rating_initialize = function(e, a) {
	var d = a;
	if (d == undefined) {
		d = "degree"
	}
	var f = $(e);
	f.append('<span class="rating-1"></span>');
	f.append('<span class="rating-2"></span>');
	f.append('<span class="rating-3"></span>');
	f.append('<span class="rating-4"></span>');
	f.append('<span class="rating-5"></span>');
	var c = f.children("span");
	for (var b = 0; b < 5; b++) {
		c[b]._val = b + 1
	}
	e.rating_value = 3;
	var g = function(j) {
		for (var h = 0; h < 5; h++) {
			if (d == "degree") {
				c[h].innerHTML = h < j ? "★" : "☆"
			} else {
				c[h].innerHTML = h == j - 1 ? "★" : "☆"
			}
		}
	};
	g(e.rating_value);
	f.children("span").mouseover(function() {
		var h = this._val;
		g(h)
	});
	f.children("span").mouseout(function() {
		g(e.rating_value)
	});
	f.children("span").click(function() {
		var h = this._val;
		e.rating_value = h;
		g(h);
		if (e.onratingchanged != null) {
			e.onratingchanged(h)
		}
	});
	e.rating_set = function(h) {
		if (h == undefined) {
			return
		}
		e.rating_value = h;
		g(h)
	};
	return e
};
var pkuvis_rating_text = function(d, c) {
	var b = "";
	if (c == undefined) {
		c = "degree"
	}
	for (var a = 0; a < 5; a++) {
		if (c == "degree") {
			b += a < d ? "★" : "☆"
		} else {
			b += a == d - 1 ? "★" : "☆"
		}
	}
	return b
};
$(".pkuvis-rating").each(function() {
	pkuvis_rating_initialize(this)
});
var measureTextBlock = function(c, h, f) {
	var b = 0;
	var a = [];
	var g = 0;
	for (var d = 0; d < h.length; d++) {
		var e = c.measureText(h[d]).width;
		if (h[d] == "\n") {
			b = 0;
			a.push(h.substr(g, d - g));
			g = d + 1
		}
		if (b + e > f) {
			b = 0;
			a.push(h.substr(g, d - g));
			g = d
		}
		b += e
	}
	if (g < h.length) {
		a.push(h.substr(g))
	}
	return a
};
